<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteor Madness - A Beginner's Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .screen { display: none; opacity: 0; transition: opacity 0.7s ease-in-out; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .screen.active { display: flex; opacity: 1; }
        .typing-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: white; animation: blink 0.7s infinite; margin-left: 4px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .dialog-box { position: relative; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(56, 189, 248, 0.4); border-radius: 1rem; box-shadow: 0 0 25px rgba(56, 189, 248, 0.2); }
        
        /* Default mobile pointer */
        .dialog-box::after { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border: 20px solid transparent; border-top-color: rgba(56, 189, 248, 0.4); border-bottom: 0; }
        
        /* Reposition pointer on larger screens where layout is horizontal */
        @media (min-width: 768px) {
            .dialog-box::after {
                top: 50%;
                left: -20px;
                bottom: auto;
                border-top: 20px solid transparent;
                border-bottom: 20px solid transparent;
                border-left: 0;
                border-right: 20px solid rgba(56, 189, 248, 0.4);
                transform: translateY(-50%);
            }
        }
        
        .btn { display: inline-block; min-width: 130px; margin: 5px; padding: 10px 20px; border-radius: 8px; border: 2px solid #00baff; color: #00baff; background: rgba(0, 20, 40, 0.4); text-transform: uppercase; font-family: 'Orbitron', 'Rajdhani', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 12px rgba(0, 186, 255, 0.3); }
        .btn:hover { background: rgba(0, 60, 100, 0.6); box-shadow: 0 0 18px #00baff, inset 0 0 8px #0077ff; transform: scale(1.05); }
        .btn:disabled { cursor: not-allowed; opacity: 0.5; transform: scale(1.0); }
        .name-input { background: rgba(15, 23, 42, 0.7); border: 1px solid #00baff; border-radius: 6px; color: white; padding: 8px 12px; font-family: 'Orbitron', sans-serif; transition: all 0.3s; width: 100%; max-width: 300px; }
        .name-input:focus { box-shadow: 0 0 12px rgba(0, 186, 255, 0.5); }
        .info-box { background: rgba(2, 6, 23, 0.7); border-left: 4px solid #38bdf8; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; transition: opacity 0.5s; }
        .quiz-feedback { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 600; }
        .feedback-correct { background-color: rgba(22, 163, 74, 0.3); border: 1px solid #16a34a; color: #4ade80; }
        .feedback-incorrect { background-color: rgba(220, 38, 38, 0.3); border: 1px solid #dc2626; color: #f87171; }
        #deflection-game .tool { cursor: grab; transition: transform 0.2s; text-align: center; }
        #deflection-game .tool:hover { transform: scale(1.1); }
        #deflection-target { border: 2px dashed #9ca3af; transition: all 0.3s; }
        #deflection-target.drag-over { border-color: #38bdf8; background-color: rgba(56, 189, 248, 0.2); }
        #deflection-target.correct { border-color: #4ade80; background-color: rgba(74, 222, 128, 0.2); }
        .certificate { border: 4px solid #fde047; background: linear-gradient(rgba(1, 23, 42, 0.9), rgba(1, 23, 42, 0.95)); padding: 1.5rem; sm:padding: 2rem; text-align: center; }
        #navigation-ui { position: fixed; bottom: 0; left: 0; width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 100; }
        .nav-text { color: #9ca3af; font-size: 0.9rem; }
        .icon-btn { background: rgba(0, 20, 40, 0.4); border: 2px solid #00baff; color: #00baff; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 12px rgba(0, 186, 255, 0.3); }
        .icon-btn:hover { background: rgba(0, 60, 100, 0.6); box-shadow: 0 0 18px #00baff, inset 0 0 8px #0077ff; transform: scale(1.1); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { position: relative; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(56, 189, 248, 0.6); border-radius: 1rem; padding: 1.5rem; sm:padding: 2rem; box-shadow: 0 0 35px rgba(56, 189, 248, 0.3); width: 90%; max-width: 600px; animation: modal-appear 0.5s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .modal-header { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; sm:font-size: 1.8rem; color: #38bdf8; margin-bottom: 1rem; text-align: center; }
        .modal-body p { margin-bottom: 1rem; }
        .close-button { position: absolute; top: 15px; right: 20px; color: #9ca3af; font-size: 2rem; font-weight: bold; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; }
        .close-button:hover, .close-button:focus { color: #fff; text-decoration: none; transform: scale(1.2); }
        
        /* --- RESPONSIVE CHAT WINDOW --- */
        #chat-window {
            position: fixed;
            bottom: 90px;
            /* Mobile: Centered with margins */
            left: 5%;
            right: 5%;
            width: 90%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            /* Original styles */
            height: 500px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(56, 189, 248, 0.4); border-radius: 1rem; box-shadow: 0 0 35px rgba(56, 189, 248, 0.3); z-index: 900; display: flex; flex-direction: column; transform: translateY(20px); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }
        /* Desktop: Revert to bottom-right corner */
        @media (min-width: 640px) { /* sm breakpoint */
            #chat-window {
                left: auto;
                right: 20px;
                width: 350px;
                margin-left: 0;
                margin-right: 0;
            }
        }
        #chat-window.active { transform: translateY(0); opacity: 1; visibility: visible; }
        
        .chat-header { padding: 1rem; background: rgba(0, 20, 40, 0.6); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(56, 189, 248, 0.4); font-family: 'Orbitron', sans-serif; }
        .chat-close-btn { background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; }
        #chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 10px 15px; border-radius: 12px; max-width: 80%; line-height: 1.5; }
        .bot-message { background-color: rgba(56, 189, 248, 0.2); border: 1px solid rgba(56, 189, 248, 0.4); align-self: flex-start; border-bottom-left-radius: 2px; }
        .user-message { background-color: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.8); align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-options-area { display: flex; padding: 1rem; border-top: 1px solid rgba(56, 189, 248, 0.4); background: rgba(0, 20, 40, 0.6); flex-direction: column; }
        #chat-options-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chat-option-btn { background: transparent; border: 1px solid #00baff; color: #00baff; font-size: 0.8rem; padding: 6px 10px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
        .chat-option-btn:hover { background: rgba(0, 186, 255, 0.2); }
    </style>
</head>
<body class="bg-slate-900 text-white">

    <canvas id="bg-canvas"></canvas>

    <div id="name-screen" class="screen flex-col justify-center items-center p-4 active">
        <div class="text-center p-6 sm:p-8 dialog-box max-w-lg">
            <h1 class="text-2xl sm:text-3xl font-bold font-['Orbitron'] text-sky-300 mb-4">Welcome, Trainee!</h1>
            <p class="text-slate-300 mb-6">Please enter your name to begin your planetary defense training mission.</p>
            <input type="text" id="name-input" class="name-input text-center text-lg" placeholder="Enter Your Name">
            <button id="start-mission-btn" class="btn block mx-auto mt-6">Start Mission</button>
        </div>
    </div>
    
    <div id="welcome-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice, the guide" class="w-full h-auto drop-shadow-lg"></div>
            <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-6">
                <div class="dialog-box p-6 rounded-lg w-full"><p id="dialog-1" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <div class="flex flex-wrap justify-center md:justify-start">
                    <button id="begin-button" class="btn opacity-0 invisible">Begin Journey</button>
                    <button id="info-button" class="btn opacity-0 invisible">What's an Asteroid?</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="orbit-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice"></div>
            <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-4">
                <div class="dialog-box p-6 w-full"><p id="dialog-2" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <a href="public/orbit-position.html" target="_blank"><button id="position-button" class="btn opacity-0 invisible">Visualize Orbit</button></a>
                <div id="info-box-orbit" class="info-box opacity-0 invisible w-full"><p><strong>Did you know?</strong> Asteroid orbits can be slightly changed by the gravity of giant planets like Jupiter! This is called gravitational perturbation.</p></div>
            </div>
        </div>
    </div>

    <div id="impact-location-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice"></div>
            <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-6">
                <div class="dialog-box p-6 w-full"><p id="dialog-3" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <a href="https://location-impact.vercel.app/" target="_blank"><button id="location-button" class="btn opacity-0 invisible">Explore Impact Zones</button></a>
            </div>
        </div>
    </div>

    <div id="impact-area-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice"></div>
            <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-4">
                <div class="dialog-box p-6 w-full"><p id="dialog-4" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <a href="https://jesnajiju-nasa.hf.space" target="_blank"><button id="area-button" class="btn opacity-0 invisible">Analyze Area & Intensity</button></a>
                <div id="quiz-container" class="w-full opacity-0 invisible"></div>
            </div>
        </div>
    </div>

    <div id="preventive-measures-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
         <div class="relative w-full max-w-5xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
            <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice"></div>
            <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-6">
                <div class="dialog-box p-6 w-full"><p id="dialog-5" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <div id="deflection-game" class="w-full p-4 rounded-lg bg-slate-900/50 border border-sky-500/20 opacity-0 invisible">
                    <div id="deflection-target" class="p-4 rounded-lg mb-4 text-center">
                        <p class="font-['Orbitron']">‚òÑÔ∏è ASTEROID (Drag Correct Tool Here)</p>
                    </div>
                    <div class="flex justify-around text-center text-sm md:text-base">
                        <div class="tool" draggable="true" data-tool="net">üï∏Ô∏è<br>Space Net</div>
                        <div class="tool" draggable="true" data-tool="impactor">üöÄ<br>Kinetic Impactor</div>
                        <div class="tool" draggable="true" data-tool="laser">üí•<br>Laser Beam</div>
                    </div>
                     <div id="game-feedback" class="text-center mt-2 h-6 font-semibold"></div>
                </div>
                <a href="preventivemeasures.html" target="_blank"><button id="preventive-button" class="btn opacity-0 invisible">Learn More about Deflection</button></a>
            </div>
        </div>
    </div>

    <div id="conclusion-screen" class="screen flex-col justify-center items-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8">
             <div class="w-2/3 max-w-[180px] sm:w-1/2 sm:max-w-xs md:w-1/3 md:max-w-sm"><img src="image.png" alt="Alice"></div>
             <div class="w-full md:w-2/3 flex flex-col items-center md:items-start gap-6">
                <div class="dialog-box p-6 w-full"><p id="dialog-6" class="text-lg md:text-xl lg:text-2xl leading-relaxed"></p></div>
                <div id="certificate-container" class="w-full certificate opacity-0 invisible transition-opacity duration-700">
                    <h2 class="text-amber-300 font-['Orbitron'] text-xl sm:text-2xl mb-2">Certificate of Completion</h2>
                    <p class="text-slate-300">This certifies that</p>
                    <p id="cert-name" class="text-white text-2xl sm:text-3xl font-bold font-['Orbitron'] my-4"></p>
                    <p class="text-slate-300">has successfully completed the Planetary Defense training.</p>
                </div>
             </div>
        </div>
    </div>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-button">&times;</span>
            <h2 class="modal-header">‚òÑÔ∏è All About Asteroids! ‚ú®</h2>
            <div class="modal-body">
                <p><strong>Asteroids are space rocks!</strong> They are leftovers from when our solar system was just getting started, about 4.6 billion years ago.</p>
                <p>Most of them live in the "Asteroid Belt," a cosmic racetrack between the planets Mars and Jupiter. ü™ê</p>
                <p>They come in all shapes and sizes. Some are tiny like a pebble, while the biggest one, Ceres, is so huge it's also called a "dwarf planet"! üåç</p>
                <p>Scientists study asteroids because they can teach us about the history of our amazing universe!</p>
            </div>
        </div>
    </div>

    <button id="chat-toggle-btn" class="icon-btn fixed bottom-5 right-5 z-[101]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
    </button>
    <div id="chat-window">
        <div class="chat-header"><span>Chat with Alice</span><button id="chat-close-btn" class="chat-close-btn">&times;</button></div>
        <div id="chat-messages"></div>
        <div class="chat-options-area">
            <div id="chat-options-container">
                </div>
        </div>
    </div>

    <div id="navigation-ui" class="opacity-0 invisible transition-opacity duration-700">
        <button id="back-arrow-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
        <p class="nav-text hidden md:block">Use arrow keys or click the buttons to navigate</p>
        <button id="forward-arrow-btn" class="icon-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- BACKGROUND ANIMATION (Unchanged) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('bg-canvas'),
            antialias: true,
            alpha: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.z = 10;
        const starVertices = [];
        for (let i = 0; i < 15000; i++) {
            const x = (Math.random() - 0.5) * 2000;
            const y = (Math.random() - 0.5) * 2000;
            const z = (Math.random() - 1) * 1000;
            starVertices.push(x, y, z);
        }
        const starGeometry = new THREE.BufferGeometry();
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.7, transparent: true, opacity: 0.8 });
        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);
        const asteroidGeometry = new THREE.DodecahedronGeometry(1, 0);
        const asteroidMaterial = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.8, metalness: 0.5 });
        for (let i = 0; i < 50; i++) {
            const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
            const z = (Math.random() - 1) * 500;
            asteroid.position.set((Math.random() - 0.5) * 100, (Math.random() - 0.5) * 100, z);
            asteroid.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
            const scale = Math.random() * 0.5 + 0.2;
            asteroid.scale.set(scale, scale, scale);
            scene.add(asteroid);
        }
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 3, 5);
        scene.add(directionalLight);
        const animControls = { cameraSpeed: 0.005, baseSpeed: 0.005, boostSpeed: 0.15 };
        function animate() {
            requestAnimationFrame(animate);
            camera.position.z -= animControls.cameraSpeed;
            if (camera.position.z < -200) camera.position.z = 200;
            stars.position.z = camera.position.z * 0.01;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // --- STORY AND INTERACTIVITY LOGIC (Unchanged) ---
        let userName = "Trainee";
        let currentStoryStage = 'name';
        
        const nameInput = document.getElementById('name-input');
        const screens = {
            name: document.getElementById('name-screen'),
            welcome: document.getElementById('welcome-screen'),
            orbit: document.getElementById('orbit-screen'),
            impactLocation: document.getElementById('impact-location-screen'),
            impactArea: document.getElementById('impact-area-screen'),
            preventiveMeasures: document.getElementById('preventive-measures-screen'),
            conclusion: document.getElementById('conclusion-screen'),
        };
        const buttons = {
            startMission: document.getElementById('start-mission-btn'),
            begin: document.getElementById('begin-button'),
            info: document.getElementById('info-button'),
            position: document.getElementById('position-button'),
            location: document.getElementById('location-button'),
            area: document.getElementById('area-button'),
            preventive: document.getElementById('preventive-button'),
        };
        const dialogElements = {
            1: document.getElementById('dialog-1'),
            2: document.getElementById('dialog-2'),
            3: document.getElementById('dialog-3'),
            4: document.getElementById('dialog-4'),
            5: document.getElementById('dialog-5'),
            6: document.getElementById('dialog-6'),
        };
        const navigationUI = document.getElementById('navigation-ui');

        const dialogs = {
            1: { text: "Greetings, {{name}}! I'm Alice. Welcome to your mission briefing. Are you ready to begin?" },
            2: { text: "Excellent, {{name}}! Every near-Earth object follows a specific orbit. Understanding this path is our first priority. Click on the button below and search any number or name (if you know) to find the respective asteriod." },
            3: { text: "With the orbit known, we can predict where it might strike. These are called impact corridors. Click below to check the locations of various asteroids, its historical impact, potential hazardous ones, track them, and check the location for any asteriod." },
            4: { text: "The energy an impact releases is immense. You can explore the impact by clicking the button below, but first, a quick knowledge check for you, {{name}}!" },
            5: { text: "Good work. Now, {{name}}, let's see how we can stop it. Drag the correct deflection tool onto the asteroid target. Click below and give values to understand the impact and choose second option to see how we can prevent it." },
            6: { text: "Mission accomplished, {{name}}! Thank you for completing your training. Your awareness is a key part of planetary defense." }
        };

        function getPersonalizedDialog(num) {
            return dialogs[num].text.replace('{{name}}', userName);
        }

        function typeWriter(element, text, speed, onComplete) {
            let i = 0;
            element.innerHTML = "";
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);
            function type() {
                if (i < text.length) {
                    element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
                    i++;
                    setTimeout(type, speed);
                } else {
                    cursor.style.display = 'none';
                    if (onComplete) onComplete();
                }
            }
            type();
        }

        function showScreen(screenId) {
            currentStoryStage = screenId;
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenId].classList.add('active');
        }

        function fadeInElement(element) {
            element.classList.remove('invisible', 'opacity-0');
            element.classList.add('opacity-100');
        }
        
        const screenOrder = ['name', 'welcome', 'orbit', 'impactLocation', 'impactArea', 'preventiveMeasures', 'conclusion'];
        function navigate(direction) {
            const currentIndex = screenOrder.indexOf(currentStoryStage);
            const nextIndex = direction === 'forward' ? currentIndex + 1 : currentIndex - 1;

            if (nextIndex < 0 || nextIndex >= screenOrder.length) return;

            const nextScreenId = screenOrder[nextIndex];
            const dialogNum = nextIndex;
            
            document.querySelector('.screen.active').classList.remove('active');
            animControls.cameraSpeed = animControls.boostSpeed;

            setTimeout(() => {
                showScreen(nextScreenId);
                animControls.cameraSpeed = animControls.baseSpeed;
                
                if (dialogNum > 0 && dialogNum <= 6) {
                    typeWriter(dialogElements[dialogNum], getPersonalizedDialog(dialogNum), 40, () => {
                        if (nextScreenId === 'welcome') {
                            fadeInElement(buttons.begin);
                            fadeInElement(buttons.info);
                        }
                        if (nextScreenId === 'orbit') {
                            fadeInElement(buttons.position);
                            fadeInElement(document.getElementById('info-box-orbit'));
                        }
                        if (nextScreenId === 'impactLocation') fadeInElement(buttons.location);
                        if (nextScreenId === 'impactArea') {
                            fadeInElement(buttons.area);
                            setupImpactQuiz();
                        }
                        if (nextScreenId === 'preventiveMeasures') {
                            fadeInElement(buttons.preventive);
                            fadeInElement(document.getElementById('deflection-game'));
                        }
                         if (nextScreenId === 'conclusion') {
                            fadeInElement(document.getElementById('certificate-container'));
                        }
                    });
                }
            }, 750);
        }
        
        function setupImpactQuiz() {
            const container = document.getElementById('quiz-container');
            fadeInElement(container);
            container.innerHTML = `
                <div class="text-sky-300 font-semibold mb-2 text-center">Which event was a major asteroid impact?</div>
                <div class="flex flex-col items-center gap-2">
                    <button class="btn quiz-option w-full text-sm" data-correct="true">Dinosaur Extinction Event</button>
                    <button class="btn quiz-option w-full text-sm" data-correct="false">The 1908 Tunguska Event</button>
                </div>
                <div id="quiz-feedback-container" class="mt-2 h-8"></div>`;
            document.querySelectorAll('.quiz-option').forEach(b => b.addEventListener('click', handleQuizAnswer));
        }

        function handleQuizAnswer(e) {
            const selectedButton = e.target;
            const isCorrect = selectedButton.dataset.correct === 'true';
            const feedbackContainer = document.getElementById('quiz-feedback-container');

            if (isCorrect) {
                feedbackContainer.innerHTML = `<div class="quiz-feedback feedback-correct">Correct! That was the Chicxulub impactor.</div>`;
            } else {
                feedbackContainer.innerHTML = `<div class="quiz-feedback feedback-incorrect">The Tunguska event was a large meteor air burst, not a direct crater impact. Good guess though!</div>`;
            }
            document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);
        }

        const tools = document.querySelectorAll('#deflection-game .tool');
        const target = document.getElementById('deflection-target');
        const gameFeedback = document.getElementById('game-feedback');

        tools.forEach(tool => {
            tool.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.tool); });
        });
        target.addEventListener('dragover', (e) => { e.preventDefault(); target.classList.add('drag-over'); });
        target.addEventListener('dragleave', () => { target.classList.remove('drag-over'); });
        target.addEventListener('drop', (e) => {
            e.preventDefault();
            target.classList.remove('drag-over');
            const droppedTool = e.dataTransfer.getData('text/plain');
            if (droppedTool === 'impactor') {
                gameFeedback.textContent = 'Correct! The DART mission proved this works.';
                gameFeedback.style.color = '#4ade80';
                target.classList.add('correct');
            } else {
                gameFeedback.textContent = 'Incorrect method. Try again!';
                gameFeedback.style.color = '#f87171';
            }
        });
        
        buttons.startMission.addEventListener('click', () => {
            const enteredName = nameInput.value.trim();
            if (enteredName) {
                userName = enteredName;
                document.getElementById('cert-name').textContent = userName;
                navigate('forward');
                fadeInElement(navigationUI);
            } else {
                nameInput.placeholder = "Please enter a name!";
            }
        });

        buttons.begin.addEventListener('click', () => navigate('forward'));
        document.getElementById('forward-arrow-btn').addEventListener('click', () => navigate('forward'));
        document.getElementById('back-arrow-btn').addEventListener('click', () => navigate('backward'));
        document.addEventListener('keydown', (e) => {
            if (currentStoryStage === 'name' && e.key === 'Enter') {
                buttons.startMission.click();
            } else if (currentStoryStage !== 'name') {
                 if (e.key === 'ArrowRight') navigate('forward');
                 if (e.key === 'ArrowLeft') navigate('backward');
            }
        });

        const infoModal = document.getElementById('info-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        buttons.info.addEventListener('click', () => { infoModal.style.display = 'flex'; });
        closeModalBtn.addEventListener('click', () => { infoModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == infoModal) infoModal.style.display = 'none'; });

        // --- OPTION-BASED CHATBOT LOGIC (Unchanged) ---
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatWindow = document.getElementById('chat-window');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatMessages = document.getElementById('chat-messages');
        const optionsContainer = document.getElementById('chat-options-container');

        const chatKnowledgeBase = {
            'main': {
                question: "I'm Alice, your mission guide. What would you like to know more about?",
                options: [
                    { text: "The Basics", next: 'basics' },
                    { text: "Famous Impacts", next: 'history' },
                    { text: "Planetary Defense", next: 'defense' },
                    { text: "How We Track Them", next: 'tracking' }
                ]
            },
            'basics': {
                question: "Let's cover the basics. What's on your mind?",
                options: [
                    { text: "Asteroid vs Meteor?", next: 'basics_difference' },
                    { text: "Where are they from?", next: 'basics_origin' },
                    { text: "‚¨ÖÔ∏è Back to Main Menu", next: 'main' }
                ]
            },
            'basics_difference': {
                answer: "An ASTEROID is a rock in space. A METEOR is that same rock burning up in our atmosphere ('shooting star'). A METEORITE is what's left if it hits the ground.",
                options: [{ text: "‚¨ÖÔ∏è Back to Basics", next: 'basics' }]
            },
            'basics_origin': {
                answer: "Most asteroids are from the 'Main Asteroid Belt', a huge ring of space rocks located between the orbits of Mars and Jupiter. They are leftover materials from the formation of our solar system.",
                options: [{ text: "‚¨ÖÔ∏è Back to Basics", next: 'basics' }]
            },
            'history': {
                question: "There have been some incredible impact events in Earth's history. Which one interests you?",
                options: [
                    { text: "Dinosaur Extinction", next: 'history_dinos' },
                    { text: "Tunguska Event (1908)", next: 'history_tunguska' },
                    { text: "Chelyabinsk (2013)", next: 'history_chelyabinsk' },
                    { text: "‚¨ÖÔ∏è Back to Main Menu", next: 'main' }
                ]
            },
            'history_dinos': {
                answer: "The Chicxulub impactor, which hit Mexico ~66 million years ago, caused the extinction of the dinosaurs. The asteroid was estimated to be about 10 kilometers (6 miles) wide!",
                options: [{ text: "‚¨ÖÔ∏è Back to History", next: 'history' }]
            },
            'history_tunguska': {
                answer: "In 1908, a meteor exploded in the air over Siberia, flattening 80 million trees over a 2,150 sq km area. It was an 'air burst' - it didn't create a crater. This is the largest impact event in recorded history.",
                options: [{ text: "‚¨ÖÔ∏è Back to History", next: 'history' }]
            },
            'history_chelyabinsk': {
                answer: "In 2013, a ~20-meter meteor exploded over Chelyabinsk, Russia. The shockwave shattered windows and injured over 1,500 people. It highlighted the threat of smaller, undetected objects.",
                options: [{ text: "‚¨ÖÔ∏è Back to History", next: 'history' }]
            },
            'defense': {
                question: "Protecting Earth is our goal. This is called Planetary Defense. What method do you want to learn about?",
                options: [
                    { text: "Kinetic Impactor (DART)", next: 'defense_dart' },
                    { text: "Gravity Tractor", next: 'defense_gravity' },
                    { text: "Other Ideas", next: 'defense_other' },
                    { text: "‚¨ÖÔ∏è Back to Main Menu", next: 'main' }
                ]
            },
            'defense_dart': {
                answer: "The DART mission (2022) was a huge success! NASA intentionally crashed a spacecraft into an asteroid to change its path. This 'kinetic impactor' technique is our most proven defense method right now.",
                options: [{ text: "‚¨ÖÔ∏è Back to Defense", next: 'defense' }]
            },
            'defense_gravity': {
                answer: "A 'gravity tractor' involves parking a heavy spacecraft near an asteroid. Over a long time (years!), the spacecraft's tiny gravitational pull would slowly tug the asteroid onto a new, safer course. It's slow but very precise.",
                options: [{ text: "‚¨ÖÔ∏è Back to Defense", next: 'defense' }]
            },
            'defense_other': {
                answer: "Scientists have other ideas too, like using lasers to vaporize rock off an asteroid's surface (creating thrust), or in extreme emergencies, using a nuclear device to push or destroy a large threat.",
                options: [{ text: "‚¨ÖÔ∏è Back to Defense", next: 'defense' }]
            },
            'tracking': {
                question: "Finding asteroids before they find us is key. How are we doing that?",
                options: [
                    { text: "How do we find them?", next: 'tracking_how' },
                    { text: "What's a 'PHA'?", next: 'tracking_pha' },
                    { text: "‚¨ÖÔ∏è Back to Main Menu", next: 'main' }
                ]
            },
            'tracking_how': {
                answer: "We use powerful ground-based telescopes like Pan-STARRS and the Catalina Sky Survey. They repeatedly scan the night sky, and computers look for tiny dots of light that are moving against the background stars.",
                options: [{ text: "‚¨ÖÔ∏è Back to Tracking", next: 'tracking' }]
            },
            'tracking_pha': {
                answer: "A PHA, or 'Potentially Hazardous Asteroid,' is an asteroid larger than 140 meters that can get closer to Earth than 7.5 million km. NASA tracks all of these very carefully.",
                options: [{ text: "‚¨ÖÔ∏è Back to Tracking", next: 'tracking' }]
            }
        };

        function addMessage(text, sender) {
            const msg = document.createElement('div');
            msg.classList.add('chat-message', `${sender}-message`);
            msg.textContent = text;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayChatNode(nodeKey) {
            const node = chatKnowledgeBase[nodeKey];
            if (!node) return;
            const message = node.question || node.answer;
            if(message) {
                  addMessage(message.replace('{{name}}', userName), 'bot');
            }
            optionsContainer.innerHTML = '';
            if (node.options) {
                node.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'chat-option-btn';
                    btn.textContent = option.text;
                    btn.onclick = () => {
                        addMessage(option.text, 'user');
                        setTimeout(() => displayChatNode(option.next), 400);
                    };
                    optionsContainer.appendChild(btn);
                });
            }
        }

        chatToggleBtn.addEventListener('click', () => chatWindow.classList.toggle('active'));
        chatCloseBtn.addEventListener('click', () => chatWindow.classList.remove('active'));

        let chatInitialized = false;
        chatToggleBtn.addEventListener('click', () => {
            if (!chatInitialized && chatWindow.classList.contains('active')) {
                chatMessages.innerHTML = '';
                setTimeout(() => displayChatNode('main'), 500);
                chatInitialized = true;
            }
        });
    </script>
</body>
</html>
